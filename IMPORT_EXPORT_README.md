# Функциональность Импорта/Экспорта Конфигурации

## Обзор

Реализована полная функциональность импорта и экспорта конфигурации MediaMTX в формате YAML. Это позволяет пользователям:

- **Экспортировать** текущую конфигурацию в YAML файл для резервного копирования или передачи
- **Импортировать** конфигурацию из YAML файла для быстрого восстановления или настройки

## Использование

### Экспорт конфигурации

1. Запустите приложение MediaMTX Configuration Editor
2. В верхней панели инструментов нажмите кнопку **"Экспорт"** (иконка скачивания)
3. Файл `mediamtx_config.yaml` будет автоматически скачан в папку загрузок

### Импорт конфигурации

1. В верхней панели инструментов нажмите кнопку **"Импорт"** (иконка загрузки)
2. Выберите YAML файл конфигурации (`.yaml` или `.yml`)
3. После успешного импорта страница автоматически перезагрузится с новыми настройками

## Структура YAML файла

Конфигурация экспортируется в структурированном формате:

```yaml
app:
  logLevel: info
  readTimeout: 10s
  writeTimeout: 10s

auth:
  internal: true
  external: false

rtsp:
  address: :8554
  encryption: optional

webrtc:
  address: :8888
  encryption: false

hls:
  address: :8888
  segmentCount: 7

rtmp:
  address: :1935

srt:
  address: :8890

pathDefaults:
  # Настройки по умолчанию для всех путей

paths:
  camera1:
    source: "rtsp://192.168.1.100:554/stream1"
    sourceProtocol: rtsp
    sourceOnDemand: true
  camera2:
    source: "rtsp://192.168.1.200:554/stream2"
    sourceProtocol: rtsp
```

## Валидация

При импорте выполняется строгая валидация:

- ✅ Проверка корректности YAML синтаксиса
- ✅ Валидация структуры конфигурации
- ✅ Проверка наличия обязательных секций
- ✅ Валидация типов данных
- ✅ Проверка Pydantic моделями

## Обработка ошибок

### При экспорте:
- Ошибки логируются в файл
- Пользователь получает уведомление об ошибке
- Экспорт прерывается при критических ошибках

### При импорте:
- **Некорректный YAML**: Ошибка валидации формата
- **Недостающие секции**: Требуются обязательные разделы (paths, app и т.д.)
- **Неверные типы данных**: Проверка соответствия ожидаемым типам
- **Ошибки кодировки**: Поддерживается только UTF-8

## Безопасность

- ✅ Валидация всех импортируемых данных
- ✅ Санитизация имен файлов
- ✅ Ограничение размера загружаемых файлов
- ✅ Проверка на вредоносный код в конфигурации

## Тестирование

### Запуск тестов

```bash
source .venv/bin/activate
python test_import_export.py
```

### Ручное тестирование

1. **Экспорт/Импорт цикла**:
   - Экспортируйте текущую конфигурацию
   - Импортируйте только что экспортированный файл
   - Убедитесь, что конфигурация не изменилась

2. **Тестирование с тестовыми данными**:
   - Используйте файл `test_config.yaml` для тестирования
   - Проверьте, что все секции корректно импортируются

3. **Обработка ошибок**:
   - Попробуйте импортировать поврежденный YAML файл
   - Убедитесь, что отображаются понятные сообщения об ошибках

## Архитектура

### Backend компоненты:

1. **`MtxConfigManager`**:
   - `export_config()`: Экспорт в YAML строку
   - `import_config(yaml_content)`: Импорт из YAML строки
   - Валидация импортированных данных

2. **`YAMLClient`**:
   - `export_config(data)`: Конвертация в YAML
   - `import_config(yaml_data)`: Конвертация из YAML
   - Преобразование между внутренним и YAML форматами

3. **UI компоненты**:
   - Кнопки импорта/экспорта в заголовке
   - Обработка загрузки файлов
   - Пользовательские уведомления

### Data Flow:

```
Экспорт:
UI → MtxConfigManager.export_config()
    → YAMLClient.export_config()
    → File Download

Импорт:
File Upload → MtxConfigManager.import_config()
    → YAMLClient.import_config()
    → UI Refresh
```

## Расширение функциональности

### Возможные улучшения:

1. **Шаблоны конфигурации**:
   - Предустановленные шаблоны для типичных сценариев
   - Настройки по умолчанию для разных типов камер

2. **Сравнение конфигураций**:
   - Diff между текущей и импортируемой конфигурацией
   - Подтверждение изменений перед импортом

3. **История изменений**:
   - Логирование всех операций импорта/экспорта
   - Возможность отката к предыдущим версиям

4. **Массовые операции**:
   - Импорт/экспорт нескольких конфигураций
   - Пакетное обновление настроек

## Troubleshooting

### Частые проблемы:

1. **"Ошибка при экспорте"**:
   - Проверьте права доступа к файлам
   - Убедитесь, что конфигурация валидна

2. **"Ошибка при импорте"**:
   - Проверьте формат YAML файла
   - Убедитесь, что файл не поврежден
   - Проверьте кодировку (должна быть UTF-8)

3. **"Файл не загружен"**:
   - Проверьте размер файла
   - Убедитесь, что выбран правильный тип файла (.yaml/.yml)

### Логи:

Все операции логируются в:
- Консоль приложения
- Файлы логов (если настроено)
- UI уведомления для пользователя
